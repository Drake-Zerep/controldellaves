<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Control Completo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --info-color: #17a2b8;
            --light-color: #ecf0f1;
        }
        
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .header {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            color: white;
            padding: 1.5rem 0;
            margin-bottom: 2rem;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
            transition: transform 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            background-color: var(--secondary-color);
            color: white;
            border-radius: 10px 10px 0 0 !important;
            font-weight: 600;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border: none;
        }
        
        .btn-success {
            background-color: var(--success-color);
            border: none;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            border: none;
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            border: none;
            color: white;
        }
        
        .btn-info {
            background-color: var(--info-color);
            border: none;
            color: white;
        }
        
        .table th {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .badge-status {
            padding: 0.5em 0.8em;
            border-radius: 20px;
            font-size: 0.85em;
        }
        
        .badge-disponible {
            background-color: var(--success-color);
            color: white;
        }
        
        .badge-prestada {
            background-color: var(--danger-color);
            color: white;
        }
        
        .badge-dentro {
            background-color: var(--warning-color);
            color: white;
        }
        
        .badge-fuera {
            background-color: var(--success-color);
            color: white;
        }
        
        .badge-activa {
            background-color: var(--info-color);
            color: white;
        }
        
        .badge-entregada {
            background-color: var(--success-color);
            color: white;
        }
        
        .filter-section {
            background-color: var(--light-color);
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
        }
        
        .footer {
            background-color: var(--secondary-color);
            color: white;
            padding: 1rem 0;
            margin-top: 2rem;
            border-radius: 10px 10px 0 0;
        }
        
        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }
        
        .logo {
            font-weight: 700;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
        }
        
        .logo-icon {
            margin-right: 10px;
            font-size: 2rem;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        
        .datetime-inputs {
            display: flex;
            gap: 10px;
        }
        
        .date-input, .time-input {
            flex: 1;
        }
        
        .autocomplete-items {
            position: absolute;
            border: 1px solid #d4d4d4;
            border-bottom: none;
            border-top: none;
            z-index: 99;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            background-color: white;
        }
        
        .autocomplete-items div {
            padding: 10px;
            cursor: pointer;
            background-color: #fff;
            border-bottom: 1px solid #d4d4d4;
        }
        
        .autocomplete-items div:hover {
            background-color: #e9e9e9;
        }
        
        .autocomplete-active {
            background-color: var(--primary-color) !important;
            color: white;
        }
        
        .key-input-container, .vehicle-input-container, .card-input-container {
            position: relative;
        }
        
        .nav-tabs .nav-link {
            color: var(--secondary-color);
            font-weight: 500;
        }
        
        .nav-tabs .nav-link.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .tab-content {
            padding-top: 1.5rem;
        }
        
        .add-button-container {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 1rem;
        }
        
        .backup-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        @media (max-width: 768px) {
            .action-buttons {
                flex-direction: column;
            }
            
            .datetime-inputs {
                flex-direction: column;
            }
            
            .add-button-container {
                justify-content: center;
            }
            
            .backup-button {
                bottom: 10px;
                right: 10px;
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <!-- Modal de Login -->
    <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="loginModalLabel">Iniciar Sesión</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="login-form">
                        <div class="mb-3">
                            <label for="login-email" class="form-label">Correo Electrónico</label>
                            <input type="email" class="form-control" id="login-email" required>
                        </div>
                        <div class="mb-3">
                            <label for="login-password" class="form-label">Contraseña</label>
                            <input type="password" class="form-control" id="login-password" required>
                        </div>
                        <div class="alert alert-danger d-none" id="login-error"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="login-button">Iniciar Sesión</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <div class="logo">
                    <span class="logo-icon">🔑 🚗 💳</span>
                    Sistema de Control Completo
                </div>
                <div class="text-end">
                    <small>Fecha: <span id="current-date"></span></small>
                    <br>
                    <small>Usuario: <span id="current-user"></span></small>
                    <button class="btn btn-sm btn-danger ms-2" id="logout-button" style="display:none">Cerrar Sesión</button>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Botón de respaldo flotante -->
        <button class="btn btn-warning backup-button" data-bs-toggle="modal" data-bs-target="#backupModal" title="Respaldo de Datos">
            💾
        </button>

        <!-- Pestañas -->
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="keys-tab" data-bs-toggle="tab" data-bs-target="#keys" type="button" role="tab" aria-controls="keys" aria-selected="true">Control de Llaves</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="vehicles-tab" data-bs-toggle="tab" data-bs-target="#vehicles" type="button" role="tab" aria-controls="vehicles" aria-selected="false">Registro de Vehículos</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="cards-tab" data-bs-toggle="tab" data-bs-target="#cards" type="button" role="tab" aria-controls="cards" aria-selected="false">Control de Tarjetas</button>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            <!-- Pestaña de Llaves -->
            <div class="tab-pane fade show active" id="keys" role="tabpanel" aria-labelledby="keys-tab">
                <div class="add-button-container">
                    <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#addKeyModal">
                        + Añadir Llave
                    </button>
                </div>
                <div class="card">
                    <div class="card-header">
                        Registrar Préstamo de Llave
                    </div>
                    <div class="card-body">
                        <form id="key-form">
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <label for="key-number" class="form-label">Número de Llave</label>
                                    <div class="key-input-container">
                                        <input type="text" class="form-control" id="key-number" required autocomplete="off">
                                        <div id="key-autocomplete" class="autocomplete-items"></div>
                                    </div>
                                    <small class="form-text text-muted">Comience a escribir el número o nombre de la llave</small>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="department" class="form-label">Departamento</label>
                                    <input type="text" class="form-control" id="department" required readonly>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="pickup-date" class="form-label">Fecha de Recogida</label>
                                    <div class="datetime-inputs">
                                        <input type="date" class="form-control date-input" id="pickup-date" required>
                                        <input type="time" class="form-control time-input" id="pickup-time" required>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="person-name" class="form-label">Nombre de la Persona</label>
                                    <input type="text" class="form-control" id="person-name" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-9 mb-3"></div>
                                <div class="col-md-3 mb-3 d-flex align-items-end">
                                    <button type="submit" class="btn btn-primary w-100">Registrar</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Listado de Préstamos de Llaves</span>
                        <span class="badge bg-primary" id="total-keys">Total: 0</span>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>N° Llave</th>
                                        <th>Departamento</th>
                                        <th>Persona</th>
                                        <th>Recogida</th>
                                        <th>Entrega</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="keys-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="filter-section">
                    <div class="row align-items-center">
                        <div class="col-md-6 mb-3">
                            <label for="filter-date-keys" class="form-label">Filtrar por fecha:</label>
                            <input type="date" class="form-control" id="filter-date-keys">
                        </div>
                        <div class="col-md-6 mb-3 d-flex justify-content-end">
                            <button id="export-pdf-keys" class="btn btn-success">Exportar a PDF</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pestaña de Vehículos -->
            <div class="tab-pane fade" id="vehicles" role="tabpanel" aria-labelledby="vehicles-tab">
                <div class="add-button-container">
                    <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#addVehicleModal">
                        + Añadir Vehículo
                    </button>
                </div>
                <div class="card">
                    <div class="card-header">
                        Registro de Entrada/Salida de Vehículos
                    </div>
                    <div class="card-body">
                        <form id="vehicle-form">
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <label for="vehicle-plate" class="form-label">Matrícula</label>
                                    <div class="vehicle-input-container">
                                        <input type="text" class="form-control" id="vehicle-plate" required autocomplete="off">
                                        <div id="vehicle-autocomplete" class="autocomplete-items"></div>
                                    </div>
                                    <small class="form-text text-muted">Comience a escribir la matrícula</small>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="vehicle-company" class="form-label">Empresa</label>
                                    <input type="text" class="form-control" id="vehicle-company" required readonly>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="entry-date" class="form-label">Fecha de Entrada</label>
                                    <div class="datetime-inputs">
                                        <input type="date" class="form-control date-input" id="entry-date" required>
                                        <input type="time" class="form-control time-input" id="entry-time" required>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="exit-date" class="form-label">Fecha de Salida</label>
                                    <div class="datetime-inputs">
                                        <input type="date" class="form-control date-input" id="exit-date">
                                        <input type="time" class="form-control time-input" id="exit-time">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-9 mb-3"></div>
                                <div class="col-md-3 mb-3 d-flex align-items-end">
                                    <button type="submit" class="btn btn-primary w-100">Registrar</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Listado de Vehículos</span>
                        <span class="badge bg-primary" id="total-vehicles">Total: 0</span>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Matrícula</th>
                                        <th>Empresa</th>
                                        <th>Entrada</th>
                                        <th>Salida</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="vehicles-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="filter-section">
                    <div class="row align-items-center">
                        <div class="col-md-6 mb-3">
                            <label for="filter-date-vehicles" class="form-label">Filtrar por fecha:</label>
                            <input type="date" class="form-control" id="filter-date-vehicles">
                        </div>
                        <div class="col-md-6 mb-3 d-flex justify-content-end">
                            <button id="export-pdf-vehicles" class="btn btn-success">Exportar a PDF</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pestaña de Tarjetas -->
            <div class="tab-pane fade" id="cards" role="tabpanel" aria-labelledby="cards-tab">
                <div class="add-button-container">
                    <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#addCardModal">
                        + Añadir Tarjeta
                    </button>
                </div>
                <div class="card">
                    <div class="card-header">
                        Control de Tarjetas
                    </div>
                    <div class="card-body">
                        <form id="card-form">
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <label for="card-number" class="form-label">Número de Tarjeta</label>
                                    <div class="card-input-container">
                                        <input type="text" class="form-control" id="card-number" required autocomplete="off">
                                        <div id="card-autocomplete" class="autocomplete-items"></div>
                                    </div>
                                    <small class="form-text text-muted">Comience a escribir el número de tarjeta</small>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="card-owner" class="form-label">Propietario</label>
                                    <input type="text" class="form-control" id="card-owner" required readonly>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="card-pickup-date" class="form-label">Fecha de Recogida</label>
                                    <div class="datetime-inputs">
                                        <input type="date" class="form-control date-input" id="card-pickup-date" required>
                                        <input type="time" class="form-control time-input" id="card-pickup-time" required>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="card-return-date" class="form-label">Fecha de Entrega</label>
                                    <div class="datetime-inputs">
                                        <input type="date" class="form-control date-input" id="card-return-date">
                                        <input type="time" class="form-control time-input" id="card-return-time">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-9 mb-3"></div>
                                <div class="col-md-3 mb-3 d-flex align-items-end">
                                    <button type="submit" class="btn btn-primary w-100">Registrar</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Listado de Tarjetas</span>
                        <span class="badge bg-primary" id="total-cards">Total: 0</span>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>N° Tarjeta</th>
                                        <th>Propietario</th>
                                        <th>Recogida</th>
                                        <th>Entrega</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="cards-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="filter-section">
                    <div class="row align-items-center">
                        <div class="col-md-6 mb-3">
                            <label for="filter-date-cards" class="form-label">Filtrar por fecha:</label>
                            <input type="date" class="form-control" id="filter-date-cards">
                        </div>
                        <div class="col-md-6 mb-3 d-flex justify-content-end">
                            <button id="export-pdf-cards" class="btn btn-success">Exportar a PDF</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container text-center">
            <p class="mb-0">Sistema de Control Completo &copy; 2023</p>
        </div>
    </footer>

    <!-- Modal Respaldo de Datos -->
    <div class="modal fade" id="backupModal" tabindex="-1" aria-labelledby="backupModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="backupModalLabel">💾 Sistema de Respaldo de Datos</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <strong>⚠️ IMPORTANTE:</strong> Los datos están respaldados automáticamente en la nube. Use las opciones a continuación para descargar copias locales.
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0">📤 Exportar Datos</h6>
                                </div>
                                <div class="card-body">
                                    <button class="btn btn-outline-success w-100 mb-2" onclick="exportData('keys')">📋 Exportar Llaves</button>
                                    <button class="btn btn-outline-success w-100 mb-2" onclick="exportData('vehicles')">🚗 Exportar Vehículos</button>
                                    <button class="btn btn-outline-success w-100 mb-2" onclick="exportData('cards')">💳 Exportar Tarjetas</button>
                                    <button class="btn btn-success w-100" onclick="exportAllData()">💾 Exportar Todo</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header bg-warning text-dark">
                                    <h6 class="mb-0">📥 Importar Datos</h6>
                                </div>
                                <div class="card-body">
                                    <input type="file" id="backupFile" class="form-control mb-2" accept=".json">
                                    <button class="btn btn-warning w-100 mb-2" onclick="importData()">📂 Importar Datos</button>
                                    <div class="form-text">
                                        <small>Seleccione un archivo JSON de respaldo</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4">
                        <div class="card">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0">🔄 Restaurar Bases de Datos</h6>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-warning">
                                    <small>Esto solo restaura las listas maestras, no afecta los registros existentes.</small>
                                </div>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-info" onclick="restoreDefaultKeys()">🔑 Restaurar Llaves Predeterminadas</button>
                                    <button class="btn btn-outline-info" onclick="restoreDefaultVehicles()">🚗 Restaurar Vehículos Predeterminados</button>
                                    <button class="btn btn-outline-info" onclick="restoreDefaultCards()">💳 Restaurar Tarjetas Predeterminadas</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <div class="card">
                            <div class="card-header bg-secondary text-white">
                                <h6 class="mb-0">📊 Información del Sistema</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <strong>Llaves:</strong><br>
                                        <span id="backup-keys-count">0 registros</span>
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Vehículos:</strong><br>
                                        <span id="backup-vehicles-count">0 registros</span>
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Tarjetas:</strong><br>
                                        <span id="backup-cards-count">0 registros</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Añadir Llave -->
    <div class="modal fade" id="addKeyModal" tabindex="-1" aria-labelledby="addKeyModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addKeyModalLabel">Añadir Nueva Llave</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="add-key-form">
                        <div class="mb-3">
                            <label for="new-key-number" class="form-label">Número de Llave</label>
                            <input type="text" class="form-control" id="new-key-number" required>
                        </div>
                        <div class="mb-3">
                            <label for="new-key-department" class="form-label">Departamento</label>
                            <input type="text" class="form-control" id="new-key-department" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="save-new-key">Guardar Llave</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Añadir Vehículo -->
    <div class="modal fade" id="addVehicleModal" tabindex="-1" aria-labelledby="addVehicleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addVehicleModalLabel">Añadir Nuevo Vehículo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="add-vehicle-form">
                        <div class="mb-3">
                            <label for="new-vehicle-plate" class="form-label">Matrícula</label>
                            <input type="text" class="form-control" id="new-vehicle-plate" required>
                        </div>
                        <div class="mb-3">
                            <label for="new-vehicle-company" class="form-label">Empresa</label>
                            <input type="text" class="form-control" id="new-vehicle-company" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="save-new-vehicle">Guardar Vehículo</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Añadir Tarjeta -->
    <div class="modal fade" id="addCardModal" tabindex="-1" aria-labelledby="addCardModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addCardModalLabel">Añadir Nueva Tarjeta</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="add-card-form">
                        <div class="mb-3">
                            <label for="new-card-number" class="form-label">Número de Tarjeta</label>
                            <input type="text" class="form-control" id="new-card-number" required>
                        </div>
                        <div class="mb-3">
                            <label for="new-card-owner" class="form-label">Propietario</label>
                            <input type="text" class="form-control" id="new-card-owner" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="save-new-card">Guardar Tarjeta</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Inicializar jsPDF
        const { jsPDF } = window.jspdf;

        // Configuración de Firebase (REEMPLAZA CON TU CONFIGURACIÓN)
        const firebaseConfig = {
            apiKey: "AIzaSyDcjX8EpgujH8G5U17Iutd8MweKk95J3Us",
            authDomain: "sistema-control-5b4fc.firebaseapp.com",
            projectId: "sistema-control-5b4fc",
            storageBucket: "sistema-control-5b4fc.firebasestorage.app",
            messagingSenderId: "95208528989",
            appId: "1:95208528989:web:3bfb9ab0b9689212d141b4"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Mostrar fecha actual
        document.getElementById('current-date').textContent = new Date().toLocaleDateString('es-ES');

        // ========== AUTENTICACIÓN ==========
        function showLoginModal() {
            const modal = new bootstrap.Modal(document.getElementById('loginModal'), { backdrop: 'static', keyboard: false });
            modal.show();
        }

        document.getElementById('login-button').addEventListener('click', async () => {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorDiv = document.getElementById('login-error');
            try {
                await auth.signInWithEmailAndPassword(email, password);
                errorDiv.classList.add('d-none');
                bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
            } catch (error) {
                errorDiv.classList.remove('d-none');
                errorDiv.textContent = 'Error: ' + error.message;
            }
        });

        document.getElementById('logout-button').addEventListener('click', () => {
            auth.signOut();
        });

        auth.onAuthStateChanged(user => {
            const logoutButton = document.getElementById('logout-button');
            const currentUser = document.getElementById('current-user');
            if (user) {
                currentUser.textContent = user.email;
                logoutButton.style.display = 'inline-block';
                initializeApp();
            } else {
                currentUser.textContent = 'No autenticado';
                logoutButton.style.display = 'none';
                showLoginModal();
            }
        });

        // ========== FUNCIONES DE BASE DE DATOS ==========
        async function loadKeyDatabase() {
            const snapshot = await db.collection('keyDatabase').get();
            return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }

        async function loadVehicleDatabase() {
            const snapshot = await db.collection('vehicleDatabase').get();
            return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }

        async function loadCardDatabase() {
            const snapshot = await db.collection('cardDatabase').get();
            return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }

        // ========== SISTEMA DE RESPALDO ==========
        async function exportData(type) {
            let data, filename;
            switch (type) {
                case 'keys':
                    const keySnapshot = await db.collection('keys').get();
                    data = keySnapshot.docs.map(doc => doc.data());
                    filename = `respaldo_llaves_${new Date().toISOString().split('T')[0]}.json`;
                    break;
                case 'vehicles':
                    const vehicleSnapshot = await db.collection('vehicles').get();
                    data = vehicleSnapshot.docs.map(doc => doc.data());
                    filename = `respaldo_vehiculos_${new Date().toISOString().split('T')[0]}.json`;
                    break;
                case 'cards':
                    const cardSnapshot = await db.collection('cards').get();
                    data = cardSnapshot.docs.map(doc => doc.data());
                    filename = `respaldo_tarjetas_${new Date().toISOString().split('T')[0]}.json`;
                    break;
            }
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            URL.revokeObjectURL(url);
            alert(`✅ Datos de ${type} exportados correctamente\n📁 Archivo: ${filename}`);
        }

        async function exportAllData() {
            const allData = {
                keys: (await db.collection('keys').get()).docs.map(doc => doc.data()),
                vehicles: (await db.collection('vehicles').get()).docs.map(doc => doc.data()),
                cards: (await db.collection('cards').get()).docs.map(doc => doc.data()),
                keyDatabase: (await db.collection('keyDatabase').get()).docs.map(doc => doc.data()),
                vehicleDatabase: (await db.collection('vehicleDatabase').get()).docs.map(doc => doc.data()),
                cardDatabase: (await db.collection('cardDatabase').get docs => doc.data()),
                exportDate: new Date().toISOString(),
                system: "Sistema de Control Completo"
            };
            const dataStr = JSON.stringify(allData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `respaldo_completo_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            alert('✅ Todos los datos exportados correctamente\n💾 Respaldo completo generado');
        }

        async function importData() {
            const fileInput = document.getElementById('backupFile');
            const file = fileInput.files[0];
            if (!file) {
                alert('❌ Por favor, seleccione un archivo de respaldo');
                return;
            }
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    let importedCount = 0;
                    let message = '';
                    if (Array.isArray(data)) {
                        if (data.length > 0) {
                            if (data[0].keyNumber) {
                                for (const item of data) {
                                    await db.collection('keys').add(item);
                                }
                                renderKeys();
                                importedCount++;
                                message += '✅ Registros de llaves importados\n';
                            } else if (data[0].number && data[0].department) {
                                for (const item of data) {
                                    await db.collection('keyDatabase').add(item);
                                }
                                setupKeyAutocomplete();
                                importedCount++;
                                message += '✅ Base de datos de llaves importada\n';
                            } else if (data[0].plate) {
                                for (const item of data) {
                                    await db.collection('vehicles').add(item);
                                }
                                renderVehicles();
                                importedCount++;
                                message += '✅ Registros de vehículos importados\n';
                            } else if (data[0].cardNumber) {
                                for (const item of data) {
                                    await db.collection('cards').add(item);
                                }
                                renderCards();
                                importedCount++;
                                message += '✅ Registros de tarjetas importados\n';
                            }
                        }
                    } else if (typeof data === 'object') {
                        if (data.keyDatabase) {
                            for (const item of data.keyDatabase) {
                                await db.collection('keyDatabase').add(item);
                            }
                            setupKeyAutocomplete();
                            importedCount++;
                            message += '✅ Base de datos de llaves importada\n';
                        }
                        if (data.keys) {
                            for (const item of data.keys) {
                                await db.collection('keys').add(item);
                            }
                            renderKeys();
                            importedCount++;
                            message += '✅ Registros de llaves importados\n';
                        }
                        if (data.vehicleDatabase) {
                            for (const item of data.vehicleDatabase) {
                                await db.collection('vehicleDatabase').add(item);
                            }
                            setupVehicleAutocomplete();
                            importedCount++;
                            message += '✅ Base de datos de vehículos importada\n';
                        }
                        if (data.vehicles) {
                            for (const item of data.vehicles) {
                                await db.collection('vehicles').add(item);
                            }
                            renderVehicles();
                            importedCount++;
                            message += '✅ Registros de vehículos importados\n';
                        }
                        if (data.cardDatabase) {
                            for (const item of data.cardDatabase) {
                                await db.collection('cardDatabase').add(item);
                            }
                            setupCardAutocomplete();
                            importedCount++;
                            message += '✅ Base de datos de tarjetas importada\n';
                        }
                        if (data.cards) {
                            for (const item of data.cards) {
                                await db.collection('cards').add(item);
                            }
                            renderCards();
                            importedCount++;
                            message += '✅ Registros de tarjetas importados\n';
                        }
                    }
                    if (importedCount > 0) {
                        alert(message + `\n📊 Total: ${importedCount} conjuntos importados`);
                    } else {
                        alert('⚠️ No se reconocieron datos válidos en el archivo');
                    }
                    fileInput.value = '';
                    bootstrap.Modal.getInstance(document.getElementById('backupModal')).hide();
                    updateBackupInfo();
                } catch (error) {
                    alert('❌ Error al importar: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        async function restoreDefaultKeys() {
            if (confirm('¿Está seguro de que desea restaurar la base de datos de llaves a los valores predeterminados?')) {
                const defaultKeys = [
                    { number: "1", department: "Economato" },
                    { number: "2", department: "Restaurante babbo american grill" },
                    { number: "3", department: "Cocina babbo american grill" },
                    { number: "4", department: "Coco café" },
                    { number: "5", department: "Copia (52) Neveras" },
                    { number: "6", department: "Restaurante las rocas - barra" },
                    { number: "7", department: "Sala kentia" },
                    { number: "8", department: "Lava bar" },
                    { number: "9", department: "" },
                    { number: "10", department: "Rest. ugo e vandino" },
                    { number: "11", department: "Oficina director" },
                    { number: "12", department: "Oficina director a.b." },
                    { number: "13", department: "Candado neveras ugo&vandino" },
                    { number: "14", department: "Oficina del cheff" },
                    { number: "15", department: "Camara de cocinas 1" },
                    { number: "16", department: "Sugar reef" },
                    { number: "17", department: "Ex sala de arte" },
                    { number: "18", department: "Sunset bar" },
                    { number: "19", department: "Barefoot grill" },
                    { number: "20", department: "Lenceria" }
                ];
                await db.collection('keyDatabase').get().then(snapshot => {
                    snapshot.forEach(doc => doc.ref.delete());
                });
                for (const key of defaultKeys) {
                    await db.collection('keyDatabase').add(key);
                }
                setupKeyAutocomplete();
                alert('✅ Base de datos de llaves restaurada');
            }
        }

        async function restoreDefaultVehicles() {
            if (confirm('¿Está seguro de que desea restaurar la base de datos de vehículos a los valores predeterminados?')) {
                const defaultVehicles = [
                    { plate: "8173CTG", company: "7 ISLAS, PISCINAS Y HORMIGONES" },
                    { plate: "6952GSC", company: "7 ISLAS, PISCINAS Y HORMIGONES" },
                    { plate: "7264HTK", company: "7ISLA" },
                    { plate: "6952DSC", company: "7ISLA" },
                    { plate: "5533JPW", company: "ACQUAJET" },
                    { plate: "7736KBY", company: "ADEJE LIMPIO" },
                    { plate: "3189LDF", company: "ADEJE LIMPIO" },
                    { plate: "8128FLF", company: "ADEJE LIMPIO" }
                ];
                await db.collection('vehicleDatabase').get().then(snapshot => {
                    snapshot.forEach(doc => doc.ref.delete());
                });
                for (const vehicle of defaultVehicles) {
                    await db.collection('vehicleDatabase').add(vehicle);
                }
                setupVehicleAutocomplete();
                alert('✅ Base de datos de vehículos restaurada');
            }
        }

        async function restoreDefaultCards() {
            if (confirm('¿Está seguro de que desea restaurar la base de datos de tarjetas a los valores predeterminados?')) {
                const defaultCards = [
                    { number: "1", owner: "MOISES VEGUILLA BERNAL" },
                    { number: "2", owner: "JUAN CARLOS COELLO HERNANDEZ" },
                    { number: "3", owner: "RICARDO JACINTO" },
                    { number: "4", owner: "RENIER MARTINEZ DOMINGUEZ" },
                    { number: "5", owner: "RICHARD JONAY PEREZ VENEECKEN" },
                    { number: "6", owner: "NANCY HORTENCIA ALVAREZ" },
                    { number: "7", owner: "CAMARERA PISOS GUARDIA" },
                    { number: "8", owner: "EVA MARIA ARZOLA ARZOLA" },
                    { number: "9", owner: "IRENE CABRERA RAMOS" },
                    { number: "10", owner: "FELIX JAVIER EXPOSITO" },
                    { number: "100", owner: "JUAN CARLOS MESA NIEBLA" },
                    { number: "101", owner: "ANTONIO VICENTE ALVAREZ BRITO" },
                    { number: "102", owner: "SPA" }
                ];
                await db.collection('cardDatabase').get().then(snapshot => {
                    snapshot.forEach(doc => doc.ref.delete());
                });
                for (const card of defaultCards) {
                    await db.collection('cardDatabase').add(card);
                }
                setupCardAutocomplete();
                alert('✅ Base de datos de tarjetas restaurada');
            }
        }

        async function updateBackupInfo() {
            const keysCount = (await db.collection('keys').get()).docs.length;
            const vehiclesCount = (await db.collection('vehicles').get()).docs.length;
            const cardsCount = (await db.collection('cards').get()).docs.length;
            document.getElementById('backup-keys-count').textContent = `${keysCount} registros`;
            document.getElementById('backup-vehicles-count').textContent = `${vehiclesCount} registros`;
            document.getElementById('backup-cards-count').textContent = `${cardsCount} registros`;
        }

        // ========== FUNCIONES GENERALES ==========
        function setCurrentDateTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const currentDate = `${year}-${month}-${day}`;
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const currentTime = `${hours}:${minutes}`;
            document.getElementById('pickup-date').value = currentDate;
            document.getElementById('pickup-time').value = currentTime;
            document.getElementById('entry-date').value = currentDate;
            document.getElementById('entry-time').value = currentTime;
            document.getElementById('card-pickup-date').value = currentDate;
            document.getElementById('card-pickup-time').value = currentTime;
        }

        function combineDateTime(date, time) {
            if (!date || !time) return null;
            return `${date}T${time}:00`;
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${day}/${month}/${year} ${hours}:${minutes}`;
        }

        // ========== AUTOCOMPLETADO ==========
        async function setupKeyAutocomplete() {
            const keyInput = document.getElementById('key-number');
            const departmentInput = document.getElementById('department');
            const autocompleteDiv = document.getElementById('key-autocomplete');
            const keys = await loadKeyDatabase();
            keyInput.addEventListener('input', () => {
                const value = keyInput.value.toLowerCase();
                autocompleteDiv.innerHTML = '';
                if (!value) return;
                const matches = keys.filter(key => 
                    key.number.toLowerCase().includes(value) || 
                    key.department.toLowerCase().includes(value)
                );
                matches.forEach(key => {
                    const div = document.createElement('div');
                    div.textContent = `${key.number} - ${key.department}`;
                    div.addEventListener('click', () => {
                        keyInput.value = key.number;
                        departmentInput.value = key.department;
                        autocompleteDiv.innerHTML = '';
                    });
                    autocompleteDiv.appendChild(div);
                });
            });
        }

        async function setupVehicleAutocomplete() {
            const plateInput = document.getElementById('vehicle-plate');
            const companyInput = document.getElementById('vehicle-company');
            const autocompleteDiv = document.getElementById('vehicle-autocomplete');
            const vehicles = await loadVehicleDatabase();
            plateInput.addEventListener('input', () => {
                const value = plateInput.value.toLowerCase();
                autocompleteDiv.innerHTML = '';
                if (!value) return;
                const matches = vehicles.filter(vehicle => 
                    vehicle.plate.toLowerCase().includes(value) || 
                    vehicle.company.toLowerCase().includes(value)
                );
                matches.forEach(vehicle => {
                    const div = document.createElement('div');
                    div.textContent = `${vehicle.plate} - ${vehicle.company}`;
                    div.addEventListener('click', () => {
                        plateInput.value = vehicle.plate;
                        companyInput.value = vehicle.company;
                        autocompleteDiv.innerHTML = '';
                    });
                    autocompleteDiv.appendChild(div);
                });
            });
        }

        async function setupCardAutocomplete() {
            const cardInput = document.getElementById('card-number');
            const ownerInput = document.getElementById('card-owner');
            const autocompleteDiv = document.getElementById('card-autocomplete');
            const cards = await loadCardDatabase();
            cardInput.addEventListener('input', () => {
                const value = cardInput.value.toLowerCase();
                autocompleteDiv.innerHTML = '';
                if (!value) return;
                const matches = cards.filter(card => 
                    card.number.toLowerCase().includes(value) || 
                    card.owner.toLowerCase().includes(value)
                );
                matches.forEach(card => {
                    const div = document.createElement('div');
                    div.textContent = `${card.number} - ${card.owner}`;
                    div.addEventListener('click', () => {
                        cardInput.value = card.number;
                        ownerInput.value = card.owner;
                        autocompleteDiv.innerHTML = '';
                    });
                    autocompleteDiv.appendChild(div);
                });
            });
        }

        // ========== RENDERIZADO DE TABLAS ==========
        async function renderKeys(filterDate = null) {
            let query = db.collection('keys').orderBy('pickup', 'desc');
            if (filterDate) {
                const start = new Date(filterDate);
                const end = new Date(filterDate);
                end.setDate(end.getDate() + 1);
                query = query.where('pickup', '>=', start.toISOString()).where('pickup', '<', end.toISOString());
            }
            const snapshot = await query.get();
            const keys = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const tableBody = document.getElementById('keys-table-body');
            tableBody.innerHTML = '';
            keys.forEach(key => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${key.keyNumber}</td>
                    <td>${key.department}</td>
                    <td>${key.person}</td>
                    <td>${formatDate(key.pickup)}</td>
                    <td>${key.return ? formatDate(key.return) : ''}</td>
                    <td><span class="badge badge-${key.status === 'prestada' ? 'prestada' : 'disponible'}">${key.status}</span></td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-warning" onclick="returnKey('${key.id}')">Devolver</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteKey('${key.id}')">Eliminar</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            document.getElementById('total-keys').textContent = `Total: ${keys.length}`;
        }

        async function renderVehicles(filterDate = null) {
            let query = db.collection('vehicles').orderBy('entry', 'desc');
            if (filterDate) {
                const start = new Date(filterDate);
                const end = new Date(filterDate);
                end.setDate(end.getDate() + 1);
                query = query.where('entry', '>=', start.toISOString()).where('entry', '<', end.toISOString());
            }
            const snapshot = await query.get();
            const vehicles = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const tableBody = document.getElementById('vehicles-table-body');
            tableBody.innerHTML = '';
            vehicles.forEach(vehicle => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${vehicle.plate}</td>
                    <td>${vehicle.company}</td>
                    <td>${formatDate(vehicle.entry)}</td>
                    <td>${vehicle.exit ? formatDate(vehicle.exit) : ''}</td>
                    <td><span class="badge badge-${vehicle.status === 'dentro' ? 'dentro' : 'fuera'}">${vehicle.status}</span></td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-warning" onclick="exitVehicle('${vehicle.id}')">Salida</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteVehicle('${vehicle.id}')">Eliminar</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            document.getElementById('total-vehicles').textContent = `Total: ${vehicles.length}`;
        }

        async function renderCards(filterDate = null) {
            let query = db.collection('cards').orderBy('pickup', 'desc');
            if (filterDate) {
                const start = new Date(filterDate);
                const end = new Date(filterDate);
                end.setDate(end.getDate() + 1);
                query = query.where('pickup', '>=', start.toISOString()).where('pickup', '<', end.toISOString());
            }
            const snapshot = await query.get();
            const cards = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const tableBody = document.getElementById('cards-table-body');
            tableBody.innerHTML = '';
            cards.forEach(card => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${card.cardNumber}</td>
                    <td>${card.owner}</td>
                    <td>${formatDate(card.pickup)}</td>
                    <td>${card.return ? formatDate(card.return) : ''}</td>
                    <td><span class="badge badge-${card.status === 'activa' ? 'activa' : 'entregada'}">${card.status}</span></td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-warning" onclick="returnCard('${card.id}')">Devolver</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteCard('${card.id}')">Eliminar</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            document.getElementById('total-cards').textContent = `Total: ${cards.length}`;
        }

        // ========== ACCIONES ==========
        async function saveNewKey() {
            const number = document.getElementById('new-key-number').value;
            const department = document.getElementById('new-key-department').value;
            await db.collection('keyDatabase').add({ number, department });
            setupKeyAutocomplete();
            bootstrap.Modal.getInstance(document.getElementById('addKeyModal')).hide();
            alert('✅ Llave añadida');
        }

        async function saveNewVehicle() {
            const plate = document.getElementById('new-vehicle-plate').value;
            const company = document.getElementById('new-vehicle-company').value;
            await db.collection('vehicleDatabase').add({ plate, company });
            setupVehicleAutocomplete();
            bootstrap.Modal.getInstance(document.getElementById('addVehicleModal')).hide();
            alert('✅ Vehículo añadido');
        }

        async function saveNewCard() {
            const number = document.getElementById('new-card-number').value;
            const owner = document.getElementById('new-card-owner').value;
            await db.collection('cardDatabase').add({ number, owner });
            setupCardAutocomplete();
            bootstrap.Modal.getInstance(document.getElementById('addCardModal')).hide();
            alert('✅ Tarjeta añadida');
        }

        async function returnKey(id) {
            await db.collection('keys').doc(id).update({
                return: new Date().toISOString(),
                status: 'disponible'
            });
            renderKeys();
        }

        async function exitVehicle(id) {
            await db.collection('vehicles').doc(id).update({
                exit: new Date().toISOString(),
                status: 'fuera'
            });
            renderVehicles();
        }

        async function returnCard(id) {
            await db.collection('cards').doc(id).update({
                return: new Date().toISOString(),
                status: 'entregada'
            });
            renderCards();
        }

        async function deleteKey(id) {
            if (confirm('¿Eliminar este registro?')) {
                await db.collection('keys').doc(id).delete();
                renderKeys();
            }
        }

        async function deleteVehicle(id) {
            if (confirm('¿Eliminar este registro?')) {
                await db.collection('vehicles').doc(id).delete();
                renderVehicles();
            }
        }

        async function deleteCard(id) {
            if (confirm('¿Eliminar este registro?')) {
                await db.collection('cards').doc(id).delete();
                renderCards();
            }
        }

        // ========== EXPORTAR PDF ==========
        async function exportKeysToPDF() {
            const filterDate = document.getElementById('filter-date-keys').value;
            let query = db.collection('keys').orderBy('pickup', 'desc');
            if (filterDate) {
                const start = new Date(filterDate);
                const end = new Date(filterDate);
                end.setDate(end.getDate() + 1);
                query = query.where('pickup', '>=', start.toISOString()).where('pickup', '<', end.toISOString());
            }
            const snapshot = await query.get();
            const keys = snapshot.docs.map(doc => doc.data());
            const doc = new jsPDF();
            doc.text('Reporte de Llaves', 10, 10);
            doc.autoTable({
                head: [['N° Llave', 'Departamento', 'Persona', 'Recogida', 'Entrega', 'Estado']],
                body: keys.map(key => [
                    key.keyNumber,
                    key.department,
                    key.person,
                    formatDate(key.pickup),
                    key.return ? formatDate(key.return) : '',
                    key.status
                ])
            });
            doc.save(`reporte_llaves_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        async function exportVehiclesToPDF() {
            const filterDate = document.getElementById('filter-date-vehicles').value;
            let query = db.collection('vehicles').orderBy('entry', 'desc');
            if (filterDate) {
                const start = new Date(filterDate);
                const end = new Date(filterDate);
                end.setDate(end.getDate() + 1);
                query = query.where('entry', '>=', start.toISOString()).where('entry', '<', end.toISOString());
            }
            const snapshot = await query.get();
            const vehicles = snapshot.docs.map(doc => doc.data());
            const doc = new jsPDF();
            doc.text('Reporte de Vehículos', 10, 10);
            doc.autoTable({
                head: [['Matrícula', 'Empresa', 'Entrada', 'Salida', 'Estado']],
                body: vehicles.map(vehicle => [
                    vehicle.plate,
                    vehicle.company,
                    formatDate(vehicle.entry),
                    vehicle.exit ? formatDate(vehicle.exit) : '',
                    vehicle.status
                ])
            });
            doc.save(`reporte_vehiculos_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        async function exportCardsToPDF() {
            const filterDate = document.getElementById('filter-date-cards').value;
            let query = db.collection('cards').orderBy('pickup', 'desc');
            if (filterDate) {
                const start = new Date(filterDate);
                const end = new Date(filterDate);
                end.setDate(end.getDate() + 1);
                query = query.where('pickup', '>=', start.toISOString()).where('pickup', '<', end.toISOString());
            }
            const snapshot = await query.get();
            const cards = snapshot.docs.map(doc => doc.data());
            const doc = new jsPDF();
            doc.text('Reporte de Tarjetas', 10, 10);
            doc.autoTable({
                head: [['N° Tarjeta', 'Propietario', 'Recogida', 'Entrega', 'Estado']],
                body: cards.map(card => [
                    card.cardNumber,
                    card.owner,
                    formatDate(card.pickup),
                    card.return ? formatDate(card.return) : '',
                    card.status
                ])
            });
            doc.save(`reporte_tarjetas_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        // ========== INICIALIZACIÓN ==========
        async function initializeApp() {
            setCurrentDateTime();
            await setupKeyAutocomplete();
            await setupVehicleAutocomplete();
            await setupCardAutocomplete();
            await renderKeys();
            await renderVehicles();
            await renderCards();
            await updateBackupInfo();

            document.getElementById('key-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const keyNumber = document.getElementById('key-number').value;
                const department = document.getElementById('department').value;
                const person = document.getElementById('person-name').value;
                const pickup = combineDateTime(
                    document.getElementById('pickup-date').value,
                    document.getElementById('pickup-time').value
                );
                await db.collection('keys').add({
                    keyNumber,
                    department,
                    person,
                    pickup,
                    return: null,
                    status: 'prestada'
                });
                renderKeys();
                e.target.reset();
                setCurrentDateTime();
            });

            document.getElementById('vehicle-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const plate = document.getElementById('vehicle-plate').value;
                const company = document.getElementById('vehicle-company').value;
                const entry = combineDateTime(
                    document.getElementById('entry-date').value,
                    document.getElementById('entry-time').value
                );
                const exit = combineDateTime(
                    document.getElementById('exit-date').value,
                    document.getElementById('exit-time').value
                );
                await db.collection('vehicles').add({
                    plate,
                    company,
                    entry,
                    exit: exit || null,
                    status: exit ? 'fuera' : 'dentro'
                });
                renderVehicles();
                e.target.reset();
                setCurrentDateTime();
            });

            document.getElementById('card-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const cardNumber = document.getElementById('card-number').value;
                const owner = document.getElementById('card-owner').value;
                const pickup = combineDateTime(
                    document.getElementById('card-pickup-date').value,
                    document.getElementById('card-pickup-time').value
                );
                const returnDate = combineDateTime(
                    document.getElementById('card-return-date').value,
                    document.getElementById('card-return-time').value
                );
                await db.collection('cards').add({
                    cardNumber,
                    owner,
                    pickup,
                    return: returnDate || null,
                    status: returnDate ? 'entregada' : 'activa'
                });
                renderCards();
                e.target.reset();
                setCurrentDateTime();
            });

            document.getElementById('save-new-key').addEventListener('click', saveNewKey);
            document.getElementById('save-new-vehicle').addEventListener('click', saveNewVehicle);
            document.getElementById('save-new-card').addEventListener('click', saveNewCard);

            document.getElementById('filter-date-keys').addEventListener('change', (e) => renderKeys(e.target.value));
            document.getElementById('filter-date-vehicles').addEventListener('change', (e) => renderVehicles(e.target.value));
            document.getElementById('filter-date-cards').addEventListener('change', (e) => renderCards(e.target.value));

            document.getElementById('export-pdf-keys').addEventListener('click', exportKeysToPDF);
            document.getElementById('export-pdf-vehicles').addEventListener('click', exportVehiclesToPDF);
            document.getElementById('export-pdf-cards').addEventListener('click', exportCardsToPDF);
        }
    </script>
</body>
</html>






